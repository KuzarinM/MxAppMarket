@page
@model ScanModel
@{
    ViewData["Title"] = "SYSTEM_SCANNER";
}

<div class="max-w-2xl mx-auto space-y-8">

    <!-- SCANNER CARD -->
    <div class="bg-zinc-900 border border-zinc-800 rounded p-6 shadow-lg">
        <h2 class="text-emerald-500 font-bold tracking-widest mb-6 flex items-center gap-2">
            <span class="animate-pulse">●</span> DIRECTORY_SCANNER
        </h2>

        <form method="post" asp-page-handler="Start" id="scanForm" class="space-y-4">
            <div>
                <label class="block text-zinc-500 text-[10px] uppercase tracking-widest mb-1">Target Path</label>
                <div class="flex gap-2">
                    <input asp-for="FolderPath" id="folderInput"
                           class="flex-1 bg-zinc-950 border border-zinc-700 text-emerald-100 px-3 py-2 text-xs font-mono focus:border-emerald-500 focus:ring-0"
                           placeholder="C:\Distr\Soft" />
                </div>
                <div class="text-[10px] text-zinc-600 mt-1">Supported: .exe, .msi, .zip, .7z</div>
            </div>

            <button type="submit" id="startBtn"
                    class="w-full bg-emerald-900/20 border border-emerald-500/50 text-emerald-400 hover:bg-emerald-500 hover:text-black py-3 transition text-xs font-bold uppercase tracking-wider disabled:opacity-50 disabled:cursor-not-allowed">
                [ INITIATE_SCAN_SEQUENCE ]
            </button>
        </form>
    </div>

    <!-- UTILITIES -->
    <div class="bg-zinc-900/50 border border-zinc-800 border-dashed rounded p-4 flex items-center justify-between">
        <div>
            <h3 class="text-amber-500 font-bold text-xs uppercase">Deduplication</h3>
            <p class="text-[10px] text-zinc-500">Merge profiles by Chocolatey ID</p>
        </div>
        <form method="post" asp-page-handler="Merge">
            <button type="submit" id="mergeBtn" class="text-[10px] border border-amber-900/50 text-amber-500 hover:bg-amber-900/20 px-3 py-1 rounded transition uppercase">
                [ RUN_MERGE ]
            </button>
        </form>
    </div>

    <!-- PROGRESS CONSOLE (HIDDEN BY DEFAULT) -->
    <div id="progressCard" style="display: none;" class="bg-zinc-950 border border-zinc-800 rounded p-4 font-mono text-xs">
        <div class="flex justify-between items-center mb-2 text-zinc-400">
            <span id="statusText" class="animate-pulse">PROCESSING...</span>
            <span id="counterBadge" class="text-emerald-500">0/0</span>
        </div>

        <!-- Bar -->
        <div class="w-full bg-zinc-900 h-2 mb-4 rounded overflow-hidden border border-zinc-800">
            <div id="progressBar" class="bg-emerald-500 h-full transition-all duration-300" style="width: 0%"></div>
        </div>

        <!-- Logs -->
        <div id="logConsole" class="h-48 overflow-y-auto bg-black border border-zinc-800 p-2 text-zinc-500 space-y-1 font-mono text-[10px] scrollbar-thin">
            <div>// SYSTEM_READY</div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Сохраняем логику, меняем только визуализацию (классы)
        const startBtn = document.getElementById('startBtn');
        const folderInput = document.getElementById('folderInput');
        const progressCard = document.getElementById('progressCard');
        const progressBar = document.getElementById('progressBar');
        const statusText = document.getElementById('statusText');
        const counterBadge = document.getElementById('counterBadge');
        const logConsole = document.getElementById('logConsole');
        const mergeBtn = document.getElementById('mergeBtn');

        if(mergeBtn) mergeBtn.addEventListener('click', () => { mergeBtn.disabled = true; mergeBtn.innerText = '[ WORKING... ]'; });

        const pollInterval = setInterval(checkStatus, 1000);

        async function checkStatus() {
            try {
                const response = await fetch('?handler=Status');
                if (!response.ok) return;
                const data = await response.json();
                renderState(data);
            } catch (e) { console.error(e); }
        }

        function renderState(data) {
            if (!data.isScanning && data.total === 0) {
                progressCard.style.display = 'none';
                unlockUI();
                return;
            }
            progressCard.style.display = 'block';

            let percent = data.total > 0 ? Math.round((data.processed / data.total) * 100) : 0;
            progressBar.style.width = percent + '%';
            counterBadge.innerText = `${data.processed} / ${data.total}`;

            if (data.logs && data.logs.length > 0) {
                logConsole.innerHTML = data.logs.map(l => `<div class="border-l-2 border-zinc-800 pl-2">${l}</div>`).join('');
                logConsole.scrollTop = logConsole.scrollHeight;
            }

            if (data.isScanning) {
                lockUI();
                statusText.innerText = data.status.toUpperCase();
                statusText.className = "text-emerald-500 animate-pulse";
            } else {
                unlockUI();
                statusText.innerText = "TASK_COMPLETE";
                statusText.className = "text-emerald-400";
                progressBar.classList.add('bg-emerald-600');
            }
        }

        function lockUI() {
            if (!startBtn.disabled) {
                startBtn.disabled = true;
                folderInput.disabled = true;
                startBtn.innerText = '[ SCANNING... ]';
                startBtn.classList.add('opacity-50');
            }
        }

        function unlockUI() {
            if (startBtn.disabled) {
                startBtn.disabled = false;
                folderInput.disabled = false;
                startBtn.innerText = '[ INITIATE_SCAN_SEQUENCE ]';
                startBtn.classList.remove('opacity-50');
            }
        }
        checkStatus();
    </script>
}