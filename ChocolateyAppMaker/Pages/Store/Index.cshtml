@page
@model ChocolateyAppMaker.Pages.Store.IndexModel
@{
    ViewData["Title"] = "CATALOG";
}

<div class="grid grid-cols-1 lg:grid-cols-4 gap-8 items-start">
    <main class="lg:col-span-3 space-y-6">

        <!-- SEARCH (Same as before) -->
        <form method="get" class="relative group">
            <input type="hidden" name="Tag" value="@Model.Tag" />
            <div class="absolute -inset-0.5 bg-emerald-500/20 rounded opacity-0 group-hover:opacity-100 transition duration-500 blur"></div>
            <div class="relative flex items-center bg-zinc-900 border border-zinc-700 rounded focus-within:border-emerald-500/50 transition">
                <span class="pl-4 text-emerald-500 font-bold">></span>
                <input type="text" name="SearchTerm" value="@Model.SearchTerm" placeholder="SEARCH_PACKAGES..." class="w-full bg-transparent text-emerald-100 px-4 py-3 focus:outline-none placeholder:text-zinc-600 uppercase font-bold border-none ring-0 focus:ring-0" autocomplete="off">
                <button type="submit" class="pr-4 text-zinc-500 hover:text-emerald-400 transition">[ENTER]</button>
            </div>
        </form>

        <!-- TAGS SYSTEM (LIMITED TO 10) -->
        <div class="bg-zinc-900/30 border border-zinc-800 p-4 rounded relative">
            <div class="text-[10px] text-zinc-500 uppercase tracking-widest mb-2 flex justify-between">
                <span>Tag_Filter_Module</span>
                <span class="text-emerald-500/50">v2.1</span>
            </div>

            <!-- Active Tags -->
            @if (Model.ActiveTagsList.Any())
            {
                <div class="flex flex-wrap gap-2 mb-4 border-b border-zinc-800 pb-3">
                    @foreach (var activeTag in Model.ActiveTagsList)
                    {
                        var removeUrl = Model.GetToggleTagParam(activeTag);
                        <a asp-page="./Index" asp-route-Tag="@removeUrl" asp-route-SearchTerm="@Model.SearchTerm" class="text-[10px] bg-emerald-900/40 text-emerald-300 border border-emerald-500/40 px-2 py-1 rounded hover:bg-red-900/30 hover:text-red-400 transition uppercase font-bold flex items-center gap-1">@activeTag <i class="bi bi-x"></i></a>
                    }
                    <a asp-page="./Index" asp-route-SearchTerm="@Model.SearchTerm" class="text-[10px] text-red-500/50 hover:text-red-400 self-center uppercase">[CLEAR]</a>
                </div>
            }

            <!-- Search Input -->
            <div class="mb-3">
                <input type="text" id="tagFilterInput" class="w-full bg-zinc-950 border border-zinc-800 text-zinc-300 text-xs px-2 py-1.5 focus:border-emerald-500/50 focus:ring-0 rounded" placeholder="Type to filter tags..." />
            </div>

            <!-- Tag Cloud with Show More -->
            <div class="flex flex-wrap gap-1.5" id="tagsContainer">
                @{
                    var availableTags = Model.AllTags.Where(t => !Model.IsTagActive(t)).ToList();
                    var initialVisible = availableTags.Take(10).ToList();
                    var hiddenTags = availableTags.Skip(10).ToList();
                }

                @foreach (var t in initialVisible)
                {
                    var addUrl = Model.GetToggleTagParam(t);
                    <a asp-page="./Index" asp-route-Tag="@addUrl" asp-route-SearchTerm="@Model.SearchTerm" class="tag-item text-[10px] text-zinc-500 border border-zinc-800 hover:border-zinc-600 hover:text-emerald-400 hover:bg-zinc-900 px-2 py-0.5 rounded transition uppercase" data-tag="@t">@t</a>
                }

                @if (hiddenTags.Any())
                {
                    <div id="hiddenTagsArea" class="hidden contents">
                        @foreach (var t in hiddenTags)
                        {
                            var addUrl = Model.GetToggleTagParam(t);
                            <a asp-page="./Index" asp-route-Tag="@addUrl" asp-route-SearchTerm="@Model.SearchTerm" class="tag-item text-[10px] text-zinc-500 border border-zinc-800 hover:border-zinc-600 hover:text-emerald-400 hover:bg-zinc-900 px-2 py-0.5 rounded transition uppercase" data-tag="@t">@t</a>
                        }
                    </div>
                    <button type="button" id="toggleTagsBtn" class="text-[10px] text-emerald-500 hover:text-emerald-300 border border-zinc-800 px-2 py-0.5 rounded bg-zinc-950 uppercase" onclick="toggleTags()">
                        [ + @hiddenTags.Count MORE ]
                    </button>
                }
            </div>
        </div>

        <!-- RESULTS -->
        @if (Model.Data.TotalCount == 0)
        {
            <div class="text-center text-zinc-600 py-12 border border-dashed border-zinc-800">NO_DATA_FOUND</div>
        }
        else
        {
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                @foreach (var item in Model.Data.Items)
                {
                    <a asp-page="./Details" asp-route-id="@item.Id"
                       class="relative flex items-center gap-4 p-4 rounded bg-zinc-900/80 border border-zinc-800
                                      hover:border-emerald-500/50 hover:bg-zinc-900 hover:shadow-[0_0_15px_rgba(16,185,129,0.1)]
                                      transition-all duration-200 group overflow-hidden h-24">

                        <!-- Icon (FULL COLOR, NO GRAYSCALE) -->
                        <div class="w-12 h-12 flex-shrink-0 bg-zinc-950 rounded border border-zinc-800 p-2 group-hover:border-emerald-500/30 transition-colors flex items-center justify-center">
                            <img src="@item.DisplayIconUrl"
                                 class="max-w-full max-h-full object-contain opacity-80 group-hover:opacity-100 transition duration-300"
                                 onerror="this.src='/images/no-icon.svg'" />
                        </div>

                        <div class="overflow-hidden flex-1 min-w-0">
                            <h3 class="font-bold text-zinc-200 group-hover:text-emerald-400 transition-colors text-sm truncate uppercase tracking-wide">@item.Name</h3>
                            <div class="flex items-center gap-2 mt-1">
                                @{
                                    var ver = item.Installers.OrderByDescending(i => i.Id).FirstOrDefault()?.Version ?? "N/A";
                                }
                                <span class="text-[9px] bg-zinc-800 text-zinc-400 px-1.5 py-0.5 rounded border border-zinc-700">v.@ver</span>
                            </div>
                        </div>
                    </a>
                }
            </div>
        }
        <!-- Pagination... (код пагинации оставляем тот же) -->
        @if (Model.Data.TotalPages > 1)
        {
            <div class="flex justify-center gap-2 mt-8">
                <a asp-page="./Index" asp-route-p="@(Model.Data.PageIndex - 1)" asp-route-SearchTerm="@Model.SearchTerm" asp-route-Tag="@Model.Tag"
                   class="px-3 py-1 border border-zinc-800 text-zinc-500 hover:text-emerald-400 hover:border-emerald-500/50 text-xs transition @(!Model.Data.HasPreviousPage ? "opacity-30 pointer-events-none" : "")">
                    [ PREV ]
                </a>
                <span class="px-3 py-1 text-emerald-500 text-xs font-bold border-b border-emerald-500/20">@Model.Data.PageIndex / @Model.Data.TotalPages</span>
                <a asp-page="./Index" asp-route-p="@(Model.Data.PageIndex + 1)" asp-route-SearchTerm="@Model.SearchTerm" asp-route-Tag="@Model.Tag"
                   class="px-3 py-1 border border-zinc-800 text-zinc-500 hover:text-emerald-400 hover:border-emerald-500/50 text-xs transition @(!Model.Data.HasNextPage ? "opacity-30 pointer-events-none" : "")">
                    [ NEXT ]
                </a>
            </div>
        }
    </main>
    <!-- ASIDE (Widgets - same as before) -->
    <aside class="lg:col-span-1 space-y-6 hidden lg:block">
        <div class="bg-zinc-900/50 border border-zinc-800 p-4 text-xs">
            <div class="flex justify-between items-center mb-4 border-b border-zinc-800 pb-2">
                <span class="text-zinc-500 font-bold uppercase">System_State</span>
                <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
            </div>
            <div class="space-y-2 font-mono">
                <div class="flex justify-between"><span class="text-zinc-600">Total Apps:</span> <span class="text-zinc-300">@Model.Data.TotalCount</span></div>
                <div class="flex justify-between"><span class="text-zinc-600">Filtered:</span> <span class="text-emerald-400">@Model.Data.Items.Count</span></div>
                <div class="flex justify-between"><span class="text-zinc-600">Tags:</span> <span class="text-zinc-300">@Model.AllTags.Count</span></div>
            </div>
        </div>
    </aside>
</div>

@section Scripts {
    <script>
        const input = document.getElementById('tagFilterInput');
        const container = document.getElementById('tagsContainer');
        const tags = container.querySelectorAll('.tag-item');
        const hiddenArea = document.getElementById('hiddenTagsArea');
        const toggleBtn = document.getElementById('toggleTagsBtn');

        input.addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            // Если начали искать - показываем всё (убираем скрытие)
            if(hiddenArea) hiddenArea.classList.remove('hidden');
            if(toggleBtn) toggleBtn.style.display = 'none';

            tags.forEach(tag => {
                const text = tag.getAttribute('data-tag');
                if (text.includes(val)) {
                    tag.classList.remove('hidden');
                } else {
                    tag.classList.add('hidden');
                }
            });
        });

        function toggleTags() {
            hiddenArea.classList.remove('hidden');
            toggleBtn.style.display = 'none';
        }
    </script>
}