@page
@model ChocolateyAppMaker.Pages.Admin.UsersModel
@{
    ViewData["Title"] = "USER_MANAGEMENT";
}

<div class="space-y-6">
    <div class="flex justify-between items-center border-b border-zinc-800 pb-4">
        <h2 class="text-xl font-bold text-emerald-500 tracking-widest"><i class="bi bi-people-fill"></i> USERS</h2>
        <button onclick="openModal('createModal')" class="bg-emerald-900/20 text-emerald-400 border border-emerald-500/50 px-4 py-2 rounded text-xs font-bold uppercase hover:bg-emerald-500 hover:text-black transition">
            [ ADD_USER ]
        </button>
    </div>

    @if (TempData["Message"] != null)
    {
        <div class="bg-emerald-900/10 border border-emerald-500/30 text-emerald-400 px-4 py-3 rounded text-xs">
            > @TempData["Message"]
        </div>
    }

    <div class="bg-zinc-900 border border-zinc-800 rounded overflow-hidden">
        <table class="w-full text-left text-xs font-mono">
            <thead class="bg-zinc-950 text-zinc-500 uppercase">
                <tr>
                    <th class="p-4">Username</th>
                    <th class="p-4">Role</th>
                    <th class="p-4">Status</th>
                    <th class="p-4 text-right">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-zinc-800">
                @foreach (var user in Model.Users)
                {
                    <tr class="hover:bg-zinc-800/50 transition">
                        <td class="p-4 font-bold text-zinc-300">@user.UserName</td>
                        <td class="p-4">
                            @if (user.IsAdmin)
                            {
                                <span class="text-emerald-500 border border-emerald-500/30 px-1 rounded bg-emerald-900/10">ADMIN</span>
                            }
                            else
                            {

                                <span class="text-zinc-500 border border-zinc-700 px-1 rounded">USER</span>
                            }
                        </td>
                        <td class="p-4">
                            @if (user.IsLocked)
                            {
                                <span class="text-red-500">LOCKED</span>
                            }
                            else
                            {

                                <span class="text-emerald-500/70">ACTIVE</span>
                            }
                        </td>
                        <td class="p-4 text-right">
                            @if (user.UserName != User.Identity.Name)
                            {
                                <button class="text-emerald-500 hover:text-emerald-300 mr-2"
                                        onclick="openEdit('@user.Id', '@user.UserName', '@user.IsAdmin.ToString().ToLower()', '@user.IsLocked.ToString().ToLower()')">
                                    [EDIT]
                                </button>
                                <form method="post" asp-page-handler="Delete" asp-route-id="@user.Id" class="inline" onsubmit="return confirm('CONFIRM DELETE?');">
                                    <button class="text-red-500 hover:text-red-400">[DEL]</button>
                                </form>
                            }
                            else
                            {
                                <span class="text-zinc-600 italic">CURRENT_SESSION</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- CREATE MODAL -->
<div id="createModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm">
    <div class="bg-zinc-900 border border-emerald-500/30 w-full max-w-md p-6 rounded shadow-[0_0_50px_rgba(16,185,129,0.1)]">
        <h3 class="text-emerald-500 font-bold mb-4 border-b border-zinc-800 pb-2">NEW_USER_REGISTRATION</h3>
        <form method="post" asp-page-handler="Create" class="space-y-4">
            <div asp-validation-summary="All" class="text-red-500 text-[10px]"></div>
            <div>
                <label class="block text-zinc-500 text-[10px] uppercase mb-1">Login</label>
                <input asp-for="NewUser.UserName" class="w-full bg-zinc-950 border border-zinc-700 text-zinc-200 px-3 py-2 text-sm focus:border-emerald-500 focus:ring-0" required />
            </div>
            <div>
                <label class="block text-zinc-500 text-[10px] uppercase mb-1">Password</label>
                <input asp-for="NewUser.Password" type="password" class="w-full bg-zinc-950 border border-zinc-700 text-zinc-200 px-3 py-2 text-sm focus:border-emerald-500 focus:ring-0" required />
            </div>
            <div class="flex items-center gap-2">
                <input asp-for="NewUser.IsAdmin" type="checkbox" class="bg-zinc-950 border-zinc-700 text-emerald-500 focus:ring-0 rounded" />
                <label class="text-zinc-400 text-xs">Grant Administrator Privileges</label>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" onclick="closeModal('createModal')" class="text-zinc-500 text-xs hover:text-zinc-300">CANCEL</button>
                <button type="submit" class="bg-emerald-900/20 text-emerald-400 border border-emerald-500/50 px-4 py-2 rounded text-xs font-bold uppercase hover:bg-emerald-500 hover:text-black">CREATE</button>
            </div>
        </form>
    </div>
</div>

<!-- EDIT MODAL -->
<div id="editModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm">
    <div class="bg-zinc-900 border border-zinc-700 w-full max-w-md p-6 rounded">
        <h3 class="text-emerald-500 font-bold mb-4 border-b border-zinc-800 pb-2">EDIT_USER: <span id="editNameDisplay" class="text-white"></span></h3>
        <form method="post" asp-page-handler="Edit" class="space-y-4">
            <input type="hidden" asp-for="EditUser.Id" id="editUserId" />

            <div class="bg-zinc-950 p-3 border border-zinc-800 rounded">
                <div class="flex items-center gap-2">
                    <input asp-for="EditUser.IsAdmin" type="checkbox" id="editIsAdmin" class="bg-zinc-900 border-zinc-700 text-emerald-500 focus:ring-0 rounded" />
                    <label for="editIsAdmin" class="text-zinc-300 text-xs font-bold">Administrator</label>
                </div>
            </div>

            <div class="bg-red-900/10 p-3 border border-red-900/30 rounded">
                <div class="flex items-center gap-2">
                    <input asp-for="EditUser.IsLocked" type="checkbox" id="editIsLocked" class="bg-zinc-900 border-red-900 text-red-500 focus:ring-0 rounded" />
                    <label for="editIsLocked" class="text-red-400 text-xs font-bold">Account Locked</label>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-6">
                <button type="button" onclick="closeModal('editModal')" class="text-zinc-500 text-xs hover:text-zinc-300">CANCEL</button>
                <button type="submit" class="bg-zinc-800 text-zinc-200 border border-zinc-600 px-4 py-2 rounded text-xs font-bold uppercase hover:bg-white hover:text-black">SAVE_CHANGES</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        function openEdit(id, name, isAdmin, isLocked) {
            document.getElementById('editUserId').value = id;
            document.getElementById('editNameDisplay').innerText = name;
            document.getElementById('editIsAdmin').checked = (isAdmin === 'true');
            document.getElementById('editIsLocked').checked = (isLocked === 'true');
            openModal('editModal');
        }

        // Auto-open on error (using Razor logic injection)
        @if (ViewData["ShowCreateModal"] as bool? == true)
        {
            <text>openModal('createModal');</text>
        }
    </script>
}