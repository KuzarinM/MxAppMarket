@page "{id:int}"
@model DetailsModel
@{
    ViewData["Title"] = "EDIT: " + Model.Profile.Name;
}

<div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

    <!-- LEFT COLUMN: EDITOR (8 cols) -->
    <div class="lg:col-span-8 space-y-6">

        <!-- MAIN EDITOR CARD -->
        <div class="bg-zinc-900 border border-zinc-800 rounded p-6 shadow-lg relative group">
            <div class="absolute -inset-px bg-gradient-to-r from-emerald-500/20 to-transparent rounded opacity-0 group-hover:opacity-100 transition duration-500 pointer-events-none"></div>

            <div class="flex items-center justify-between mb-6 border-b border-zinc-800 pb-4">
                <h2 class="text-emerald-500 font-bold tracking-widest text-sm flex items-center gap-2">
                    <i class="bi bi-pencil-square"></i> METADATA_EDITOR
                </h2>

                @if (Model.Profile.Installers.Any())
                {
                    <form method="post" asp-page-handler="Rescan">
                        <input type="hidden" asp-for="Profile.Id" />
                        <button type="submit" class="text-[10px] text-zinc-400 hover:text-emerald-400 border border-zinc-700 hover:border-emerald-500 px-3 py-1 rounded transition uppercase bg-zinc-950">
                            [ FORCE_RESCAN ]
                        </button>
                    </form>
                }
            </div>

            <form method="post" asp-page-handler="UpdateMetadata" class="space-y-5 relative z-10">
                <input type="hidden" asp-for="Profile.Id" />

                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <!-- NAME -->
                    <div class="col-span-2">
                        <label class="block text-zinc-500 text-[10px] uppercase tracking-widest mb-1">Software Name</label>
                        <input asp-for="Profile.Name" class="w-full bg-zinc-950 border border-zinc-700 text-emerald-100 font-bold px-4 py-3 focus:border-emerald-500 focus:ring-0 transition" />
                    </div>

                    <!-- ID -->
                    <div>
                        <label class="block text-zinc-500 text-[10px] uppercase tracking-widest mb-1">Package ID</label>
                        <input asp-for="Profile.ChocolateyId" class="w-full bg-zinc-950 border border-zinc-700 text-zinc-300 font-mono text-xs px-3 py-2 focus:border-emerald-500 focus:ring-0" />
                    </div>

                    <!-- TAGS -->
                    <div>
                        <label class="block text-zinc-500 text-[10px] uppercase tracking-widest mb-1">Tags</label>
                        <input asp-for="Profile.Tags" class="w-full bg-zinc-950 border border-zinc-700 text-zinc-300 text-xs px-3 py-2 focus:border-emerald-500 focus:ring-0" />
                    </div>
                </div>

                <!-- DESCRIPTION -->
                <div>
                    <label class="block text-zinc-500 text-[10px] uppercase tracking-widest mb-1">Description (Markdown)</label>
                    <textarea asp-for="Profile.Description" rows="6" class="w-full bg-zinc-950 border border-zinc-700 text-zinc-300 text-xs font-mono px-3 py-2 focus:border-emerald-500 focus:ring-0 scrollbar-thin"></textarea>
                </div>

                <!-- LINKS -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-zinc-500 text-[10px] uppercase tracking-widest mb-1">Homepage URL</label>
                        <input asp-for="Profile.Homepage" class="w-full bg-zinc-950 border border-zinc-700 text-zinc-400 text-xs px-2 py-1 focus:border-emerald-500 focus:ring-0" />
                    </div>
                    <div>
                        <label class="block text-zinc-500 text-[10px] uppercase tracking-widest mb-1">Icon URL</label>
                        <div class="flex gap-2">
                            <input asp-for="Profile.IconUrl" class="w-full bg-zinc-950 border border-zinc-700 text-zinc-400 text-xs px-2 py-1 focus:border-emerald-500 focus:ring-0" oninput="updateLogoPreview(this.value)" />
                            <span class="text-zinc-600 self-center"><i class="bi bi-link-45deg"></i></span>
                        </div>
                    </div>
                </div>

                <div class="pt-4 border-t border-zinc-800">
                    <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded shadow-[0_0_15px_rgba(16,185,129,0.2)] transition text-xs uppercase tracking-wider">
                        [ SAVE_CHANGES ]
                    </button>
                </div>
            </form>
        </div>

        <!-- VERSIONS LIST -->
        <div class="bg-zinc-900 border border-zinc-800 rounded p-6 shadow-lg">
            <h3 class="text-zinc-400 font-bold tracking-widest text-xs mb-4 border-b border-zinc-800 pb-2">
                FILE_MANIFEST
            </h3>
            <div class="space-y-2">
                @foreach (var file in Model.Profile.Installers.OrderByDescending(f => f.Id))
                {
                    <div class="bg-zinc-950 border border-zinc-800 p-3 flex flex-col md:flex-row gap-4 items-start md:items-center justify-between group hover:border-zinc-600 transition">
                        <!-- Info -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="text-emerald-500 font-bold text-sm">@file.Filename</span>
                                @if (file.IsExtra)
                                {
                                    <span class="bg-zinc-800 text-zinc-400 text-[9px] px-1 rounded uppercase">EXTRA</span>
                                }
                            </div>
                            <div class="text-[10px] text-zinc-500 font-mono">@file.FilePath</div>
                        </div>

                        <!-- Inline Form -->
                        <form method="post" asp-page-handler="UpdateVersion" class="flex flex-wrap items-center gap-2 bg-zinc-900 p-2 rounded border border-zinc-800" id="form_@file.Id">
                            <input type="hidden" name="fileId" value="@file.Id" />

                            <div class="flex items-center bg-zinc-950 border border-zinc-700 rounded px-2">
                                <span class="text-zinc-500 text-[10px]">v.</span>
                                <input type="text" name="newVersion" value="@file.Version" class="w-16 bg-transparent border-none text-emerald-400 font-mono text-xs focus:ring-0 p-1" />
                            </div>

                            <input type="text" name="comment" value="@file.Comment" placeholder="// Comment..." class="w-24 md:w-32 bg-zinc-950 border border-zinc-700 text-zinc-400 text-[10px] rounded px-2 py-1 focus:ring-0 focus:border-emerald-500" />

                            <label class="flex items-center gap-1 cursor-pointer select-none">
                                <input type="checkbox" name="isExtra" value="true" @(file.IsExtra ? "checked" : "") class="rounded bg-zinc-950 border-zinc-700 text-emerald-500 focus:ring-0 w-3 h-3" />
                                <span class="text-[9px] text-zinc-500 uppercase">Aux</span>
                            </label>

                            <button class="text-emerald-500 hover:text-emerald-300 px-2"><i class="bi bi-save"></i></button>
                        </form>

                        <!-- Actions -->
                        <div class="flex gap-2">
                            @if (Model.Profile.Installers.Count > 1)
                            {
                                <form method="post" asp-page-handler="Split" onsubmit="return confirm('Extract to new profile?');">
                                    <input type="hidden" name="fileId" value="@file.Id" />
                                    <button class="text-sky-500 hover:text-sky-300 text-xs border border-zinc-800 p-1 rounded bg-zinc-900"><i class="bi bi-diagram-2"></i></button>
                                </form>
                            }
                            <a asp-page-handler="DownloadInstaller" asp-route-fileId="@file.Id" class="text-zinc-400 hover:text-zinc-200 text-xs border border-zinc-800 p-1 rounded bg-zinc-900"><i class="bi bi-download"></i></a>
                        </div>
                    </div>
                }
            </div>
        </div>

    </div>

    <!-- RIGHT COLUMN: SIDEBAR (4 cols) -->
    <div class="lg:col-span-4 space-y-6">

        <!-- LOGO & UPLOAD -->
        <div class="bg-zinc-900 border border-zinc-800 rounded p-6 text-center">
            <div class="relative w-40 h-40 mx-auto bg-zinc-950 border border-zinc-700 rounded p-4 flex items-center justify-center mb-4 group overflow-hidden">
                <!-- Цветной логотип (без grayscale) -->
                <img src="@Model.Profile.DisplayIconUrl"
                     id="mainLogoImage"
                     class="max-w-full max-h-full object-contain"
                     onerror="this.src='/images/no-icon.svg'" />

                <!-- Overlay Upload -->
                <form method="post" enctype="multipart/form-data" asp-page-handler="UploadIcon"
                      class="absolute inset-0 bg-black/80 flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300 cursor-pointer">
                    <input type="hidden" asp-for="Profile.Id" />
                    <label class="cursor-pointer text-emerald-500 text-xs uppercase font-bold flex flex-col items-center">
                        <i class="bi bi-camera mb-1 text-xl"></i> Upload
                        <input asp-for="UploadIcon" type="file" class="hidden" onchange="this.form.submit()" accept="image/*" />
                    </label>
                </form>
            </div>
            <div class="text-[10px] text-zinc-500 font-mono">IMAGE_PREVIEW</div>
        </div>

        <!-- IMPORT TOOLS -->
        <div class="bg-zinc-900 border border-emerald-500/30 rounded p-6 shadow-[0_0_20px_rgba(16,185,129,0.05)]">
            <h3 class="text-emerald-500 font-bold text-xs uppercase tracking-widest mb-4 flex items-center gap-2">
                <i class="bi bi-cloud-download"></i> Auto_Import
            </h3>

            <form method="post" asp-page-handler="Sync" class="space-y-3">
                <input type="hidden" asp-for="Profile.Id" />
                <input asp-for="ImportQuery" class="w-full bg-zinc-950 border border-zinc-700 text-zinc-300 px-3 py-2 text-xs" placeholder="Package Name / ID" />

                <div class="space-y-1">
                    <label class="flex items-center gap-2 text-zinc-400 text-xs cursor-pointer">
                        <input type="radio" asp-for="ImportSource" value="Auto" class="bg-zinc-950 border-zinc-700 text-emerald-500 focus:ring-0" /> AUTO
                    </label>
                    <label class="flex items-center gap-2 text-zinc-400 text-xs cursor-pointer">
                        <input type="radio" asp-for="ImportSource" value="Flathub" class="bg-zinc-950 border-zinc-700 text-emerald-500 focus:ring-0" /> FLATHUB
                    </label>
                    <label class="flex items-center gap-2 text-zinc-400 text-xs cursor-pointer">
                        <input type="radio" asp-for="ImportSource" value="Chocolatey" class="bg-zinc-950 border-zinc-700 text-emerald-500 focus:ring-0" /> CHOCOLATEY
                    </label>
                </div>

                <button type="submit" class="w-full bg-emerald-900/30 hover:bg-emerald-900/50 text-emerald-400 border border-emerald-500/40 py-2 rounded text-xs font-bold uppercase transition">
                    [ SYNC_METADATA ]
                </button>
            </form>
            @if (TempData["Message"] != null)
            {
                <div class="mt-2 text-[10px] text-emerald-400">> @TempData["Message"]</div>
            }
            @if (TempData["Error"] != null)
            {
                <div class="mt-2 text-[10px] text-red-400">> @TempData["Error"]</div>
            }
        </div>

        <!-- SCREENSHOTS -->
        <div class="bg-zinc-900 border border-zinc-800 rounded p-4">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-zinc-500 text-xs uppercase font-bold">Screenshots</h3>
                <form method="post" enctype="multipart/form-data" asp-page-handler="AddScreenshots">
                    <input type="hidden" asp-for="Profile.Id" />
                    <label class="text-[10px] text-emerald-500 hover:text-emerald-300 cursor-pointer uppercase border border-zinc-700 px-2 py-1 rounded bg-zinc-950">
                        [ + ADD ]
                        <input asp-for="UploadScreenshots" type="file" class="hidden" multiple accept="image/*" onchange="this.form.submit()" />
                    </label>
                </form>
            </div>

            <div class="grid grid-cols-3 gap-2">
                @if (Model.Profile.Screenshots != null)
                {
                    @foreach (var screenUrl in Model.Profile.Screenshots)
                    {
                        <div class="relative group aspect-video bg-zinc-950 border border-zinc-800">
                            <img src="@screenUrl" class="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition" />
                            <form method="post" asp-page-handler="DeleteScreenshot" class="absolute inset-0 flex items-center justify-center bg-black/60 opacity-0 group-hover:opacity-100 transition">
                                <input type="hidden" asp-for="Profile.Id" />
                                <input type="hidden" name="imageUrl" value="@screenUrl" />
                                <button class="text-red-500 hover:text-red-400"><i class="bi bi-trash"></i></button>
                            </form>
                        </div>
                    }
                }
            </div>
        </div>

    </div>
</div>

<script>
    function updateLogoPreview(url) {
        const img = document.getElementById('mainLogoImage');
        if (!url) return;
        img.src = url;
    }
</script>