@page "{id:int}"
@model ChocolateyAppMaker.Pages.Store.DetailsModel
@{
    ViewData["Title"] = Model.Profile.Name.ToUpper();
}

<div class="max-w-6xl mx-auto">

    <!-- HEADER -->
    <div class="flex flex-col md:flex-row gap-6 mb-8 items-start">
        <div class="w-24 h-24 md:w-32 md:h-32 bg-zinc-900 border border-zinc-800 rounded p-4 flex items-center justify-center flex-shrink-0 shadow-[0_0_20px_rgba(16,185,129,0.05)]">
            <img src="@Model.Profile.DisplayIconUrl"
                 class="max-w-full max-h-full object-contain filter grayscale hover:grayscale-0 transition duration-500"
                 onerror="this.src='/images/no-icon.svg'" />
        </div>
        <div class="flex-1">
            <h1 class="text-3xl font-bold text-zinc-100 uppercase tracking-wide mb-1">@Model.Profile.Name</h1>
            <div class="flex items-center gap-3 text-xs mb-4">
                <span class="text-emerald-500 font-mono">ID: @(Model.Profile.ChocolateyId ?? "LOCAL")</span>
                @if (!string.IsNullOrEmpty(Model.Profile.Homepage))
                {
                    <span class="text-zinc-700">|</span>
                    <a href="@Model.Profile.Homepage" target="_blank" class="text-zinc-500 hover:text-emerald-400 transition">[WEBSITE]</a>
                }
            </div>

            <div class="flex flex-wrap gap-2">
                @if (!string.IsNullOrEmpty(Model.Profile.Tags))
                {
                    @foreach (var tag in Model.Profile.Tags.Split(' ').Take(6))
                    {
                        <span class="text-[10px] uppercase border border-zinc-700 text-zinc-400 px-2 py-0.5 rounded bg-zinc-900/50">@tag</span>
                    }
                }
            </div>
        </div>
        <div class="flex-shrink-0">
            @{
                var latest = Model.Profile.Installers.OrderByDescending(x => x.Id).FirstOrDefault();
            }
            @if (latest != null)
            {
                <a asp-page-handler="Download" asp-route-fileId="@latest.Id"
                   class="block bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded shadow-[0_0_15px_rgba(16,185,129,0.3)] transition text-sm font-bold uppercase tracking-wider text-center">
                    <i class="bi bi-download mr-2"></i> Download v.@latest.Version
                </a>
                <div class="text-[10px] text-zinc-500 text-center mt-2 font-mono">@latest.Extension.ToUpper() / @((latest.FileSize / 1024.0 / 1024.0).ToString("F2")) MB</div>
            }
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- LEFT: INFO -->
        <div class="lg:col-span-2 space-y-8">

            <!-- CAROUSEL (JS CONTROLLED) -->
            @if (Model.Profile.Screenshots != null && Model.Profile.Screenshots.Any())
            {
                <div class="relative bg-zinc-900/50 border border-zinc-800 rounded overflow-hidden group">
                    <!-- Slides Container -->
                    <div id="carouselSlides" class="relative h-[400px] w-full">
                        @for (int i = 0; i < Model.Profile.Screenshots.Count; i++)
                        {
                            <div class="carousel-slide absolute inset-0 transition-opacity duration-300 @(i == 0 ? "opacity-100 z-10" : "opacity-0 z-0") flex items-center justify-center bg-zinc-950/80" data-index="@i">
                                <img src="@Model.Profile.Screenshots[i]" class="max-h-full max-w-full object-contain" />
                            </div>
                        }
                    </div>

                    <!-- Controls (Visible on hover) -->
                    @if (Model.Profile.Screenshots.Count > 1)
                    {
                        <button onclick="changeSlide(-1)" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-emerald-500/80 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition z-20">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <button onclick="changeSlide(1)" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-emerald-500/80 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition z-20">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                        <!-- Indicators -->
                        <div class="absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-2 z-20">
                            @for (int i = 0; i < Model.Profile.Screenshots.Count; i++)
                            {
                                <div class="w-2 h-2 rounded-full bg-white/30 slide-indicator transition @(i == 0 ? "bg-emerald-500" : "")" data-index="@i"></div>
                            }
                        </div>
                    }
                </div>
            }

            <!-- DESCRIPTION (MARKDOWN) -->
            <div class="bg-zinc-900/20 border border-zinc-800/50 p-6 rounded">
                <h3 class="text-zinc-500 uppercase tracking-widest text-xs font-bold mb-4 border-b border-zinc-800 pb-2">README.MD</h3>
                <!-- prose class from Tailwind Typography -->
                <div class="prose prose-invert prose-sm max-w-none prose-a:text-emerald-400 prose-headings:text-zinc-200 prose-pre:bg-zinc-950 prose-pre:border prose-pre:border-zinc-800">
                    @Html.Raw(Model.DescriptionHtml)
                </div>
            </div>
        </div>

        <!-- RIGHT: VERSIONS LIST -->
        <div class="lg:col-span-1">
            <div class="sticky top-4">
                <div class="bg-zinc-900 border border-zinc-800 rounded p-4">
                    <h3 class="text-emerald-500 uppercase tracking-widest text-xs font-bold mb-4 border-b border-emerald-500/20 pb-2 flex justify-between">
                        <span>Available Files</span>
                        <span>@Model.Profile.Installers.Count</span>
                    </h3>

                    <div class="space-y-3 max-h-[600px] overflow-y-auto pr-2 scrollbar-thin">
                        @{
                            var allFiles = Model.Profile.Installers.OrderByDescending(x => x.Id).ToList();
                        }
                        @if (allFiles.Any())
                        {
                            @foreach (var file in allFiles)
                            {
                                <div class="group border border-zinc-800 bg-zinc-950 p-3 hover:border-emerald-500/40 transition rounded relative overflow-hidden">
                                    @if (file.IsExtra)
                                    {
                                        <div class="absolute top-0 right-0 bg-zinc-800 text-[8px] text-zinc-400 px-1">EXTRA</div>
                                    }

                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-zinc-200 font-bold text-sm">v.@file.Version</span>
                                        <span class="text-[9px] font-mono text-zinc-500">@file.Extension</span>
                                    </div>

                                    <div class="text-[10px] text-zinc-400 mb-2 font-mono truncate">@file.Filename</div>

                                    <!-- COMMENTS BLOCK (RESTORED) -->
                                    @if (!string.IsNullOrEmpty(file.Comment))
                                    {
                                        <div class="mb-2 p-1.5 bg-yellow-900/10 border border-yellow-700/30 rounded text-[10px] text-yellow-500/80 italic">
                                            <i class="bi bi-info-circle mr-1"></i> @file.Comment
                                        </div>
                                    }

                                    <div class="flex justify-between items-center mt-2 border-t border-zinc-800/50 pt-2">
                                        <span class="text-[10px] text-zinc-600">@((file.FileSize / 1024.0 / 1024.0).ToString("F2")) MB</span>
                                        <a asp-page-handler="Download" asp-route-fileId="@file.Id" class="text-emerald-500 hover:text-emerald-300 text-[10px] font-bold uppercase hover:underline">
                                            [ DOWNLOAD ]
                                        </a>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-zinc-600 text-xs italic text-center py-4">NO_FILES_INDEXED</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // JS Carousel Logic
        let currentIndex = 0;
        const slides = document.querySelectorAll('.carousel-slide');
        const indicators = document.querySelectorAll('.slide-indicator');
        const total = slides.length;

        function changeSlide(direction) {
            slides[currentIndex].classList.remove('opacity-100', 'z-10');
            slides[currentIndex].classList.add('opacity-0', 'z-0');
            if(indicators.length) indicators[currentIndex].classList.remove('bg-emerald-500');

            currentIndex = (currentIndex + direction + total) % total;

            slides[currentIndex].classList.remove('opacity-0', 'z-0');
            slides[currentIndex].classList.add('opacity-100', 'z-10');
            if(indicators.length) indicators[currentIndex].classList.add('bg-emerald-500');
        }
    </script>
}